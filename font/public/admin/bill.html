<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../fontawesome-free-6.4.2-web/css/all.min.css">
  <link rel="stylesheet" href="../../source/stylesheet/root.css">
  <link rel="stylesheet" href="../../source/stylesheet/admin/admin.css">
	<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
	crossorigin="anonymous"></script>
	<script src="../../source/script/admin/admin.js"></script>
	<script src="../angular/angularjs.js"></script>
  <title>Document</title>
</head>
<body ng-app="AppBanHang" ng-controller="MainCtrl">
	<div class="container">

		<section id="sidebar">
			<a href="#" class="brand">
				<img src="../images/logo.png" alt="" class="img-icon">
				<img src="../images/single-logo.png" alt="" class="single-img-icon">
			</a>
			<ul class="side-menu top">
				<li>
					<a href="./admin.html">
						<i class="fa-solid fa-user"></i>
						<span class="text">Managerment</span>
					</a>
				</li>
				<li>
					<a href="./products.html">
						<i class="fa-solid fa-box"></i>
						<span class="text">Products</span>
					</a>
				</li>
				<li>
					<a href="./manafactures.html">
						<i class="fa-solid fa-industry"></i>
						<span class="text">Manafactures</span>
					</a>
				</li>
				<li>
					<a href="./customers.html">
						<i class="fa-solid fa-users"></i>
						<span class="text">Customers</span>
					</a>
				</li>
				<li class="active">
					<a href="./bill.html">
						<i class="fa-solid fa-file-invoice"></i>
						<span class="text">Bills</span>
					</a>
				</li>
				<li>
					<a href="./receipt.html">
						<i class="fa-solid fa-file-invoice-dollar"></i>
						<span class="text">Receipts</span>
					</a>
				</li>
				<li>
					<a href="./statistical.html">
						<i class="fa-solid fa-chart-simple"></i>
						<span class="text">Statistical</span>
					</a>
				</li>
			</ul>
			<ul class="side-menu">
				<li>
					<a href="#">
						<i class="fa-solid fa-wrench"></i>
						<span class="text">Settings</span>
					</a>
				</li>
				<li>
					<a href="./login.html" class="logout">
						<i class="fa-solid fa-right-from-bracket"></i>
						<span onclick="logOut()" class="text">Logout</span>
					</a>
				</li>
			</ul>
		</section>
	
	
		<section id="content">
			<!-- NAVBAR -->
			<nav>
				<i class="fa-solid fa-bars"></i>
				<a href="#" class="nav-link">Categories</a>
				<form action="#">
					<div class="form-input" style="width: 400px;">
						<input ng-model="TextSearch" type="search" placeholder="Search...">
						<button ng-click="SearchByhdbMoTa()" type="submit" class="search-btn"><i class="fa-solid fa-magnifying-glass"></i></button>
					</div>
				</form>
				<input type="checkbox" id="switch-mode" hidden>
				<label for="switch-mode" class="switch-mode"></label>
				<a href="#" class="notification">
					<i class='bx bxs-bell' ></i>
					<span class="num">8</span>
				</a>
				<a href="#" class="profile">
					<img src="../anh_nguoi.png">
				</a>
			</nav>
			<!-- NAVBAR -->
	
			<!-- MAIN -->
			<main>
				<div class="head-title">
					<div class="left">
						<h1>Dashboard</h1>
						<ul class="breadcrumb">
							<li>
								<a href="#">Dashboard</a>
							</li>
							<li><i class='bx bx-chevron-right' ></i></li>
							<li>
								<a class="active" href="#">Home</a>
							</li>
						</ul>
					</div>
					<!-- <div class="submit">
						<div class="submit__button">
							<button>Lưu</button>
						</div>
					</div> -->
					<!-- <div class="section__parents-button">
						<div class="section__button">
							<button>Thêm</button>
						</div>
					</div> -->
					<a href="#" class="btn-download">
						<i class='bx bxs-cloud-download' ></i>
						<span class="text">Download PDF</span>
					</a>
				</div>
	
				<!-- RIGHT CONTENT -->
				<!-- ENTER CONTENT -->
				<div class="right-section">
					<!-- <form>
						<div class="section-big-parents border-right">
							<div class="section__parents-label">
								<div class="section__box">
									<label for="">Nhập mã hoá đơn: </label><br>
									<input id="hdbId" name="hdbId" ng-model="hdbId" class="section__input" type="text"><br>
								</div>
								<div class="section__box">
									<label for="">Nhập mã khách hàng: </label><br>
									<input id="kId" name="kId" ng-model="kId" class="section__input" type="text"><br>
								</div>
								<div class="section__box">
									<label for="">Ngày lập hoá đơn: </label><br>
									<input id="hdbNgayLap" name="hdbNgayLap" ng-model="hdbNgayLap" class="section__input" type="datetime-local"><br>
								</div>
								<div class="section__box">
									<label for="">Mô tả: </label><br>
									<input id="hdbMoTa" name="hdbMoTa" ng-model="hdbMoTa" class="section__input" type="text"><br>
								</div>
							</div>
							<div class="section__parents-label">
								<div class="section__box">
									<label for="">Nhập mã hoá đơn: </label><br>
									<input class="section__input" type="text"><br>
								</div>
								<div class="section__box">
									<label for="">Nhập mã sản phẩm: </label><br>
									<input class="section__input" type="text"><br>
								</div>
								<div class="section__box">
									<label for="">Nhập số lượng: </label><br>
									<input class="section__input" type="text"><br>
								</div>
								<div class="section__box">
									<label for="">Nhập tổng tiền: </label><br>
									<input class="section__input" type="text"><br>
								</div>
							</div>
						</div>
					</form> -->
	
					<!-- TABLE CONTENT -->
					<table id="table" class="table-box border-right table-content-box">
						<tr class="colum">
							<th class="colum-title one">Mã hoá đơn</th>
							<th class="colum-title">Mã khách</th>
							<th class="colum-title">Ngày Lập</th>
							<th class="colum-title">Mô tả</th>
							<th class="colum-title second">Chức năng</th>
						</tr>
						<tr class="colum-content-box" ng-repeat="x in listBill.data">
							<th class="colum-content">{{x.hdbId}}</th>
							<th class="colum-content">{{x.kId}}</th>
							<th class="colum-content">{{x.hdbNgayLap}}</th>
							<th class="colum-content">{{x.hdbMoTa}}</th>
							<th class="colum-content">
								<i id="Edit" ng-click="Edit(x.hdbId)" class="fa-regular fa-pen-to-square"></i>
								<i onclick="openOverlay()" ng-click="ShowBillDetail(x.hdbId)" class="fa-solid fa-circle-info fa-trash-can"></i>
							</th>
						</tr>
					</table>
	
					<div class="navigation"></div>
				</div>
			</main>
		</section>
	</div>

	<div class="overlay" id="overlay">
		<div class="box-detail right-section">
			<table id="table" class="table-box border-right table-content-box" style="padding: 0 20px; width: 500px;">
				<tr class="colum">
					<th class="colum-title one">Mã chi tiết</th>
					<th class="colum-title">Mã sản phẩm</th>
					<th class="colum-title">Số lượng</th>
					<th class="colum-title">Tổng tiền</th>
					<th class="colum-title second">Chức năng</th>
				</tr>
				<tr class="colum-content-box" ng-repeat="x in BillDetail.list_json_chitiethoadon">
					<th class="colum-content">{{x.ctbId}}</th>
					<th class="colum-content">{{x.spId}}</th>
					<th class="colum-content">{{x.ctbSoLuong}}</th>
					<th class="colum-content">{{x.ctbTongTien}}</th>
					<th class="colum-content">
						<i id="Delete" ng-click="DeleteDetail(x.ctbId)" class="fa-solid fa-trash-can" style="margin-right: 20px;"></i>
					</th>
				</tr>
			</table>
			
			<button onclick="closeOverlay()" style="color: black;
			padding: 8px 12px;
			border: 1px solid black;
			border-radius: 14px;
			margin-top: 20px;
			margin-left: 422px;">Đóng</button>
		</div>
	</div>

	<script>
		const openOverlay = () => {
      document.getElementById("overlay").style.display = "flex";
		}
		const closeOverlay = () => {
			document.getElementById("overlay").style.display = "none";
		}

		var app = angular.module('AppBanHang', [])
		app.controller('MainCtrl', function ($scope, $http, $window) {
			$scope.listBill = [];

			$scope.Edit = function (id) {
				if(confirm("Bạn có muốn duyệt không?")) {
					const obj = {
						"hdbId": id,
						"hdbMoTa": "Đã duyệt",
						"list_json_chitiethoadon": null
					};
					$http({
							method: "PUT",
							url: "https://localhost:44390/api/Bill/check-bill",
							data: obj,
							dataType: 'json',
							headers: { "Content-Type": "application/json" }
					}).then(function (response) {
							alert('Sản phẩm đã được duyệt');
							$scope.listBill[$scope.editIndex] = response.data;
							location.reload();
						}, function () {
							alert('Không thể cập nhật sản phẩm. Vui lòng thử lại!');
						});
				}
			};


			$scope.ShowBillDetail = function (hdbId) {
				$http({
					method: "GET",
					url: "https://localhost:44390/api/Bill/get-by-id/" + hdbId,
					headers: { "Content-Type": "application/json" }
				}).then(
					function (response) {
						$scope.BillDetail = response.data;
						console.log($scope.BillDetail);
					}, function () {
						console.error('Vui lòng thử lại!');
					}
				);
			};


			$scope.DeleteDetail = function (ctbId) {
				if(confirm('Bạn có muốn xoá không?'))
				{
					$http({
						method: "DELETE",
						url: 'https://localhost:44390/api/BillDetails/delete-bill-detail?model=' + ctbId,
						dataType: 'json',
						headers: { "Content-Type": "application/json" }
					}).then(function () {
						var index = $scope.BillDetail.list_json_chitiethoadon.findIndex(x => x.ctbId === ctbId);
            if (index !== -1) {
                $scope.BillDetail.list_json_chitiethoadon.splice(index, 1);
            }
						alert('Đã được xóa thành công');
					}, function () {
						alert('Không thể xóa sản phẩm. Vui lòng thử lại!');
					});
				}
			};

			let pageIndex = 1;
			$scope.Search = function (data) {
				$http({
					method: 'POST',
					data,
					url: 'https://localhost:44390/api/Bill/search-bill',
				}).then(function (response) {
					$scope.listBill = response.data;
					var total = Number(response.data.totalItems);
					reload(total);
				});
			};

			$scope.Search({
				page: pageIndex,
				pageSize: 6
			})

			$scope.SearchByhdbMoTa = function() {
				$scope.Search({
					page: pageIndex,
					pageSize: 6,
					ten: $scope.TextSearch
				})
			}

			function reload(total) {
				const totalPages = Math.ceil(total / 6);
				document.querySelector('.navigation').innerHTML = '';
				for (let index = 0; index < totalPages; index++) {
					document.querySelector('.navigation').innerHTML += 
					`<button data-id="${index + 1}" class="btn-primary">${index + 1}</button>`;
				}
				const btnNavigation = document.querySelectorAll('button[data-id]');
				btnNavigation.forEach((item) => (
					item.onclick = () =>
						$scope.Search({
							page: item.dataset.id,
							pageSize: 6,
						})),
				);
			}
		});
	</script>
</body>
</html>